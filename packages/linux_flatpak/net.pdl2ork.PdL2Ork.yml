id: net.pdl2ork.PdL2Ork
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
default-branch: stable
command: pd-wrapper.sh
finish-args: [
    # Display
    '--share=ipc', '--socket=x11', '--socket=wayland', '--device=dri',
    # Audio access
    '--socket=pulseaudio',
    # Filesystem access (pd doesn't yet work with portals)
    '--filesystem=host',
    # MIDI access (Flatpak doesn't yet support exposing only MIDI devices)
    '--device=all'
]
modules:
- name: pd-l2ork
  buildsystem: autotools
  subdir: pd/src
  config-opts: [ '--enable-portaudio', '--enable-alsa', '--enable-oss' ]
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
  #  tag: '20230820'
  #  commit: cbe00609fc19213fac1cd6cee97039f59cf96195
  #- type: patch
  #  path: patch/build-api.patch
  - type: patch
    path: patch/no-rsync-during-install.patch

# For Gem library
- shared/glu-9.json

- name: pd-externals
  buildsystem: simple
  subdir: externals
  build-commands:
  - |
    echo EXTERNALS-0 && make prefix=/app \
         gem
  - |
    echo EXTERNALS-1 && make prefix=/app \
         adaptive arraysize autotune bassemu boids comport creb cxc cyclone
  - |
    echo EXTERNALS-2 && make prefix=/app \
         disis_flatpak earplug ekext ext13 fftease
  - |
    echo EXTERNALS-3 && make prefix=/app \
         flatgui freeverb ggee hcs iem_ambi iem_bin_ambi iemlib iemguts iem_adaptfilt iemmatrix
  - |
    echo EXTERNALS-4 && make prefix=/app \
         iemxmlrpc iem_delay iem_roomsim iem_spec2 iem_tab jasch_lib loaders-libdir lyonpotpourri mapping
  - |
    echo EXTERNALS-5 && make prefix=/app \
         markex maxlib mjlib moonlib motex mrpeach pan pdcontainer pddp pdogg plugin pmpd
  - |
    echo EXTERNALS-6 && make prefix=/app \
         rjlib sigpack smlib tof unauthorized vbap windowing
  - |
    echo EXTERNALS-INSTALL-1 && make DESTDIR=/ prefix=/app \
         adaptive_install arraysize_install autotune_install bassemu_install \
         boids_install comport_install creb_install cxc_install cyclone_install
  - |
    echo EXTERNALS-INSTALL-2 && make DESTDIR=/ prefix=/app \
         disis_install \
         earplug_install ekext_install ext13_install fftease_install
  - |
    echo EXTERNALS-INSTALL-3 && make DESTDIR=/ prefix=/app \
         flatgui_install freeverb_install ggee_install hcs_install \
         iem_ambi_install iem_bin_ambi_install iemlib_install
  - |
    echo EXTERNALS-INSTALL-4 && make DESTDIR=/ prefix=/app \
         iemguts_install iem_adaptfilt_install iemmatrix_install iemxmlrpc_install \
         iem_delay_install iem_roomsim_install iem_spec2_install iem_tab_install
  - |
    echo EXTERNALS-INSTALL-5 && make DESTDIR=/ prefix=/app \
         jasch_lib_install loaders-libdir_install lyonpotpourri_install \
         mapping_install markex_install maxlib_install mjlib_install
  - |
    echo EXTERNALS-INSTALL-6 && make DESTDIR=/ prefix=/app \
         moonlib_install motex_install mrpeach_install \
         pan_install pdcontainer_install pddp_install pdogg_install
  - |
    echo EXTERNALS-INSTALL-7 && make DESTDIR=/ prefix=/app \
         plugin_install pmpd_install rjlib_install sigpack_install smlib_install \
         tof_install unauthorized_install vbap_install windowing_install
  # The following externals from the pd-l2ork repo are not built:
  #
  #   bsaylor  -- needs fftw
  #   fluid - requires fluidsynth
  #   iemgui -- requires a config.h that it doesn't have
  #   moocow -- fails to configure
  #   oscx -- fails to configure
  #   pdlua -- requires Lua
  #   zexy -- fails to configure
  #   gem -- is also not included

  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
#    tag: '20230820'
#    commit: cbe00609fc19213fac1cd6cee97039f59cf96195

- name: pd-abstractions
  buildsystem: simple
  subdir: abstractions
  build-commands:
  - make DESTDIR=/ prefix=/app install
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
#    tag: '20230820'
#    commit: cbe00609fc19213fac1cd6cee97039f59cf96195

- name: pd-l2ork-integration
  buildsystem: simple
  build-commands:
  # These commands run in the 'subdir' that we set, but the sources appear at
  # the top level hence the `../..` everywhere.
  - mkdir -p /app/lib/pd-l2ork/bin/nw
  - tar -x -f nwjs.tar.gz -C /app/lib/pd-l2ork/bin/nw --strip-components=1
  # wrapper script
  - install -m 755 pd-wrapper.sh /app/bin
  # .desktop file (so we appear in list of applications)
  - install -d /app/share/applications/
  - install -m 644 net.pdl2ork.PdL2Ork.desktop /app/share/applications/
  # AppStream metadata (for app store / package manager)
  - install -d /app/share/metainfo/
  - install -m 644 net.pdl2ork.PdL2Ork.metainfo.xml /app/share/metainfo
  # icon (for everyone)
  - install -d /app/share/icons/hicolor/scalable/apps
  - install -m 644 net.pdl2ork.PdL2Ork.svg /app/share/icons/hicolor/scalable/apps/
  # add mime type to .pd files
  - install -d /app/share/mime/packages/
  - install -m 644 packages/linux_make/pd-l2ork.xml /app/share/mime/packages/net.pdl2ork.PdL2Ork.xml
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
 #   tag: '20230820'
 #   commit: cbe00609fc19213fac1cd6cee97039f59cf96195
  - type: file
    # Using an binary x86_64 build of nw.js makes me sad. There are ARM packages
    # available from the nw.js website. For other platforms, it's difficult but
    # possible to build nw.js and Chromium from source, good luck!
    url: https://dl.nwjs.io/v0.67.1/nwjs-v0.67.1-linux-x64.tar.gz
    sha256: 98a24a98ca7252ad9d0b56a9fc9518e76f128b436b1555355b808907f7b66bd4
    dest-filename: nwjs.tar.gz
  - type: file
    path: ./pd-wrapper.sh
  - type: file
    path: net.pdl2ork.PdL2Ork.desktop
  - type: file
    path: net.pdl2ork.PdL2Ork.metainfo.xml
  - type: file
    path: net.pdl2ork.PdL2Ork.svg
