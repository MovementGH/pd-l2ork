<!DOCTYPE html>
<html>
  <head>
    <link id="page_style" rel="stylesheet"
          type="text/css" href="css/default.css">
    <style>

input[type="number"] {
    width: 4em;
}

    </style>
  </head>
  <body class="dialog_body" style="overflow: hidden;">
    <div class="container">
      <table id="titlebar">
        <tr>
          <td style="width: 100%;">
            <div id="titlebar_title">[ggee/image] Properties</div>
          </td>
          <td id="titlebar_buttons_td">
            <div class="titlebar_buttons">
              <div id="titlebar_close_button" onclick="cancel(false);">&#215</div>
            </div>
          </td>
        </tr>
      </table>
    <form>

      <fieldset> 
        <legend data-i18n="iem.prop.heading.filename">wrong stuff</legend> 

        <table>
          <tr class="filename prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.filename_tt">
                <span data-i18n="iem.prop.filename"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.filename_tt">
              <input type="text" name="filename"
                     onchange="update_attr(this, true);"
                     style="width: 16em;">
            </td>
            <td data-i18n="[title]iem.prop.filename_browse_tt">
		      <input type="button" onClick="image_browse()" name="filebrowse"
		      		data-i18n="[title]iem.prop.filename_browse_tt" value="..."
              style="width:32px">
		      </button>
            </td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.size"></legend> 

        <table class="pairs">
          <tr class="constrain prop hidden">
            <td style="width:87px;">
              <label data-i18n="[title]iem.prop.image_constrain_tt">
                <span data-i18n="iem.prop.image_constrain"></span>
              </label>
            </td>
            <td colspan="3" data-i18n="[title]iem.prop.image_constrain_tt">
              <select name="constrain"
                     onchange="update_constrain(this);"
                     style="width: 167px;">
                <option value="0">none</option>
                <option value="1">image w/h ratio (default)</option>
                <option value="2">current w/h ratio</option>
              </select>
            </td>
          </tr>

          <tr class="visible_width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.visible_width_tt">
                <span data-i18n="iem.prop.visible_width"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_width_tt">
              <input type="number" name="visible_width" min="3"
                     onchange="update_wh(this, 0);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.visible_height_tt">
                <span data-i18n="iem.prop.visible_height"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_height_tt"
                style="text-align: right; margin-right: 1px;">
              <input type="number" name="visible_height" min="3"
                     onchange="update_wh(this, 1);">
            </td>
          </tr>

          <tr><td style="padding-bottom: 6px;"></td></tr>

          <tr class="gop_spill prop hidden">
          	<td colspan="4">
            <label data-i18n="[title]iem.prop.image_gop_spill_tt">
              <input type="checkbox" name="gop_spill" value="on"
                     onchange="update_gop_spill(this);" style="margin-left: 1px;">
              <span data-i18n="iem.prop.image_gop_spill"></span>
            </label>
            <br>
        	</td>
          </tr>

          <tr class="width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.image_sel_width_tt" class="image_sel_width_tt"> 
                <span data-i18n="iem.prop.image_sel_width" class="image_sel_width"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.image_sel_width_tt" class="image_sel_width_tt">
              <input type="number" name="width" min="3"
                     onchange="update_wh(this, 2);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.image_sel_height_tt" class="image_sel_height_tt">
                <span data-i18n="iem.prop.image_sel_height" class="image_sel_height"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.image_sel_height_tt" class="image_sel_height_tt"
                style="text-align: right; margin-right: 1px;">
              <input type="number" name="height" min="3"
                     onchange="update_wh(this, 3);">
            </td>
          </tr>

          <tr><td style="padding-bottom: 6px;"></td></tr>
        </table>

        <table class="pairs">
          <tr class="rotate prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.image_rotate_title_tt"
                  class="image_rotate_title_tt"> 
                <span data-i18n="iem.prop.image_rotate_title"
                  class="image_rotate_title"></span>
              </label>
            </td>
            <td>
              <label data-i18n="[title]iem.prop.image_rotate_x_tt" class="image_rotate_x_tt"> 
                <span data-i18n="iem.prop.image_rotate_x" class="image_rotate_x"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.image_rotate_x_tt" class="image_rotate_x_tt">
              <input type="number" name="rotate_x" style="width: 4em;"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.image_rotate_y_tt" class="image_rotate_y_tt">
                <span data-i18n="iem.prop.image_rotate_y" class="image_rotate_y"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.image_rotate_y_tt" class="image_rotate_y_tt">
              <input type="number" name="rotate_y" style="width: 4em;"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.image_rotate_tt" class="image_rotate_tt">
                <span data-i18n="iem.prop.image_rotate" class="image_rotate"
                  style="margin-left: 2px;"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.image_rotate_tt" class="image_rotate_tt"
                style="text-align: right;">
              <input type="number" name="rotate" style="width: 4em;"
                     onchange="update_attr(this);">
            </td>
          </tr>
        </table> 

        <table class="pairs">
          <tr><td style="padding-bottom: 6px;"></td></tr>

          <tr class="click prop hidden" style="margin-bottom: 7px;">
            <td style="width:87px;">
              <label data-i18n="[title]iem.prop.image_click_tt">
                <span data-i18n="iem.prop.image_click"
                  style="margin-right: 6px;"></span>
              </label>
            </td>
            <td colspan="3" data-i18n="[title]iem.prop.image_click_tt">
              <select name="click"
                     onchange="update_attr(this);"
                     style="width: 167px;">
                <option value="0">disabled (default)</option>
                <option value="1">bang on click</option>
                <option value="2">mouse(1/0) x y</option>
              </select>
            </td>
          </tr>
        </table>              
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.messages"></legend> 

        <table>
          <tr class="send_symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.send_tt">
                <span data-i18n="iem.prop.send"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.send_tt">
              <input type="text" name="send_symbol"
                     onchange="update_attr(this, true);"
                     style="width: 12em;">
            </td>
            <td>
          <tr class="receive_symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.receive_tt">
                <span data-i18n="iem.prop.receive"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.receive_tt">
              <input type="text" name="receive_symbol"
                     onchange="update_attr(this, true);"
                     style="width: 12em;">
            </td>
            <td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.label">wrong stuff</legend> 

        <table class="pairs">
          <tr class="label prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.label_tt">
                <span data-i18n="iem.prop.label"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.label_tt">
              <input type="text" name="label"
                     onchange="update_attr(this, true);"
                     style="width: 131px;">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.xoffset_tt">
                <span data-i18n="iem.prop.xoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.xoffset_tt">
              <input type="text" name="x_offset"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.yoffset_tt">
                <span data-i18n="iem.prop.yoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.yoffset_tt">
              <input type="text" name="y_offset"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="font_style prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.font_tt">
                <span data-i18n="iem.prop.font"></span>
            </td>
            <td data-i18n="[title]iem.prop.font_tt">
              <select name="font_style"
                      onchange="update_attr(this);">
                <option>DejaVu Sans Mono</option>
                <option>Helvetica</option>
                <option>Times</option>
              </select>
            </td>
            <td colspan="4" style="text-align: right;">
              <label data-i18n="[title]iem.prop.fontsize_tt">
                <span data-i18n="iem.prop.fontsize"></span>
                <input type="text" name="font_size"
                       onchange="update_attr(this);">
              <label>
            </td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
      <legend data-i18n="iem.prop.heading.colors"></legend> 

      <div class="label_color prop hidden">
        <label data-i18n="[title]iem.prop.label_color_tt">
          <input type="color" name="label_color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.label_color"></span>
        </label>
        <br>
      </div>
    </fieldset> 

    <div class="prop hidden">
      <input type="hidden" name="reset_width">
      <input type="hidden" name="reset_height">
      <input type="hidden" name="aspect_ratio">
    </div>

    <div class="submit_buttons">
      <button type="button" onClick="ok()" data-i18n="[title]iem.prop.ok_tt">
        <span data-i18n="iem.prop.ok"></span>
      </button>
      <button type="button" onClick="apply()" data-i18n="[title]iem.prop.apply_tt">
        <span data-i18n="iem.prop.apply"></span>
      </button>
      <button type="button" onClick="cancel(true)" data-i18n="[title]iem.prop.cancel_tt">
        <span data-i18n="iem.prop.cancel"></span>
      </button>
    </div>

  </form> 
  </div>  

  <span id = "openpanelSpan">
    <input style="display:none;" id="openpanel_dialog" onchange="update_filename(this);"
      type="file" />
  </span>

  <script>
"use strict";
var gui = require("nw.gui");
var pdgui = require("./pdgui.js");

// For translations
var l = pdgui.get_local_string;

// gui preset
pdgui.skin.apply(window);

var pd_object_callback,
    old_attrs = {}, // original state. Used if we cancel the dialog
    new_attrs = {}; // changed state. Used if we apply or click "Ok"

/* begin function declarations */

function substitute_space(arg) {
    var fake_space = String.fromCharCode(11);
    return arg.split(" ").join(fake_space);
}

function strip_problem_chars(arg) {
    var problem_chars = [";", ",", "\\"],
        ret = arg,
        i;
    for(i = 0; i < problem_chars.length; i++) {
        ret = ret.split(problem_chars[i]).join("");
    }
    return ret;
}

/* we use which to more easily identify which of the 4 possible variables
   we are dealing with:

   0=visible_width
   1=visible_height
   2=width
   3=height
*/
function update_wh(elem, which) {
    // match the minimum possible size to what the object allows
    if (elem.value < 8) {
        elem.value = 8;
    }

    var w  = document.getElementsByName('visible_width')[0],
        h  = document.getElementsByName('visible_height')[0],
        bw = document.getElementsByName('width')[0],
        bh = document.getElementsByName('height')[0],
        c  = parseInt(document.getElementsByName('constrain')[0].value),
        ar = parseFloat(document.getElementsByName('aspect_ratio')[0].value),
        g  = document.getElementsByName('gop_spill')[0].checked ? 1 : 0;

    // if we are dealing with visible_w/h consider the constraint
    if (which < 2) {

        if (c > 0) {
            if (which === 0) {
                h.value = parseInt(w.value / ar);
                if (h.value < 8) {
                    h.value = 8;
                    w.value = parseInt(h.value * ar);
                }
            } else {
                w.value = parseInt(h.value * ar);
                if (w.value < 8) {
                    w.value = 8;
                    h.value = parseInt(w.value / ar);
                }
            }
        }
        update_attr(w);
        update_attr(h);
        if (g) {
            if (Number(bw.value) > Number(w.value)) {
                bw.value = w.value;
                update_attr(bw);
            }
            if (Number(bh.value) > Number(h.value)) {
                bh.value = h.value;
                update_attr(bh);
            }
        }
    } else {
        // we are dealing with gop-spill values
        if (which === 2) {
            if (Number(elem.value) > Number(w.value)) {
                elem.value = w.value;
            }
        } else {
            if (Number(elem.value) > Number(h.value)) {
                elem.value = h.value;
            }
        }
        update_attr(elem);
    }
}

function update_filename(result) {
    var newfile = result.value;
    if(pdgui.nw_os_is_windows) {
        newfile = newfile.replace(/\\/g, '\/');
    }
    document.getElementsByName('filename')[0].value = newfile;
    update_attr(document.getElementsByName('filename')[0]);
}

function image_browse() {
    var start_path = pdgui.get_pd_opendir();
    pdgui.post("image_browse <" + start_path + ">");
    if(pdgui.nw_os_is_windows) {
      start_path = start_path.replace(/\//g, '\\');
    }
    // the following does not work due to nw.js bug, so we use dialog_options approach
    //document.getElementById('fileDialog').setAttribute('nwworkingdir', cur_dir);
    var dialog_options = {
          style: "display: none;",
          type: "file",
          id: "openpanel_dialog",
          onchange: "update_filename(this);",
          nwworkingdir: start_path
      };
    var input_string = pdgui.build_file_dialog_string(dialog_options);
    document.querySelector("#openpanelSpan").innerHTML = input_string;
    //<input id="fileDialog" type="file" name="name" style="display: none;"
    //  onchange="update_file(this);" nwworkingdir />
    document.getElementById('openpanel_dialog').click();
}

function update_constrain(elem) {
    var cur_w = document.getElementsByName('visible_width')[0];
    var cur_h = document.getElementsByName('visible_height')[0];
    var ar = document.getElementsByName('aspect_ratio')[0];
    if (parseInt(elem.value) === 1) {
        var ratio = document.getElementsByName('reset_width')[0].value /
            document.getElementsByName('reset_height')[0].value;
        // adjust height based on the width:
        ar.value = ratio;
    } else if (parseInt(elem.value) === 2) {
        ar.value = cur_w.value / cur_h.value;
    }
    // if the value is 0 we only update the constrain value since there is no
    // requested aspect ratio constraint. Similarly, if the value is 2, then the
    // user has specified the current width/height as the basis for the ratio,
    // so, we have also nothing else to do at this point in time.
    update_attr(elem);
    // manually request updating of the w/h values to conform to the new setting
    update_wh(cur_w, 0);

}

function update_gop_spill(elem) {
    if (elem.checked) {
      document.getElementsByName('width')[0].disabled = false;
      document.getElementsByName('height')[0].disabled = false;
    } else {
      document.getElementsByName('width')[0].disabled = true;
      document.getElementsByName('height')[0].disabled = true;
    }
    update_attr(elem);
    // manually request updating of the w/h values to conform to the new setting
    update_wh(document.getElementsByName('visible_width')[0], 0);
}

function update_attr(elem, symbol_field) {
    if (!new_attrs.hasOwnProperty(elem.name)) {
        pdgui.post("warning: new_attrs[" + elem.name + "] doesn't exist");
    }
    if (elem.type === "checkbox") {
        new_attrs[elem.name] = elem.checked ? 1 : 0;
    } else if (elem.type === "select-one") {
        new_attrs[elem.name] = elem.selectedIndex;
    } else if (elem.type === "color") {
        new_attrs[elem.name] = parseInt(elem.value.slice(1), 16)
    } else {
        new_attrs[elem.name] = (elem.value === "" && !symbol_field) ?
            "0" : elem.value;
    }
}

//Clean up strings to send as symbol arguments to Pd
function iemgui_escape(s) {
    s = !s ? "empty" : s;
    var arr = s.split("");
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === "$" && i+1 < arr.length &&
            arr[i+1] >= "0" && arr[i+1] <= "9") {
            arr[i] = "#";
        }
    }
    s = arr.join("");
    s = substitute_space(s);
    s = strip_problem_chars(s);
    return s;
}

function iemgui_unescape(s) {
    var arr = s.split("");
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === "#" && i+1 < arr.length &&
            arr[i+1] >= "0" && arr[i+1] <= "9") {
            arr[i] = "$";
        }
    }
    s = arr.join("");
    return s;
}

function send_params(attrs, create_undo_point) {

    var send_symbol = attrs.send_symbol,
        receive_symbol = attrs.receive_symbol,
        label =  attrs["label"];
    send_symbol = iemgui_escape(send_symbol);
    receive_symbol = iemgui_escape(receive_symbol);
    label = iemgui_escape(label);

    pdgui.pdsend(pd_object_callback, "dialog",
        attrs.filename,
        attrs.width,
        attrs.height,
        attrs.visible_width,
        attrs.visible_height,
        attrs.gop_spill,
        attrs.click,
        attrs.constrain,
        send_symbol,
        receive_symbol,
        attrs.rotate,
        attrs.rotate_x,
        attrs.rotate_y,
        label,
        attrs.x_offset,
        attrs.y_offset,
        attrs.label_color,
        attrs.font_style,
        attrs.font_size,
        create_undo_point ? 1 : 0 // whether we set an undo point
    );
}

function cancel(revert_changes) {
    var dirty = false, attr;
    //window.close(true);
    if (revert_changes) {
        for (attr in old_attrs) {
            if (old_attrs[attr] !== new_attrs[attr]) {
                dirty = true;
            }
        }
        if (dirty) {
            send_params(old_attrs, false);
        }
    }
    pdgui.pdsend(pd_object_callback, "cancel");
}

function apply() {
    send_params(new_attrs, false);
}

function ok() {
    // Steal focus from any active input to make sure it triggers an
    // onchange event
    document.querySelector("button").focus();
    // send the old attrs first so we can set an undo point on them
    send_params(old_attrs, false);
    send_params(new_attrs, true);
    cancel(false);
}

// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_window_id(gfxstub, attr_object) {
    var attr;
    pd_object_callback = gfxstub;
    old_attrs = attr_object;
    for (attr in old_attrs) {
        if (old_attrs.hasOwnProperty(attr)) {
            new_attrs[attr] = old_attrs[attr];
        }
    }
    console.log("attr object is " + attr_object.toString() +
        " and its type is " + attr_object.type);
    add_events(gfxstub);
    pdgui.gui_check_for_dialog_appearance_inconsistencies(gfxstub);

    // ico@vt.edu TODO: translate the window title
    // for the timebeing we just give it english version
    //document.getElementById("titlebar_title").textContent = "[" + 
    //    attr_object.type + "] Properties";

    translate_form();
    populate_form(attr_object);
    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it more efficient and
    // snappier, at least on older machines.
    document.getElementsByClassName("container")[0]
        .style.setProperty("display", "inline");
    pdgui.resize_window(pd_object_callback);
    // update constrain to calculate aspect_ratio
    update_constrain(document.getElementsByName("constrain")[0]);
    // update gop_spill to toggle editability of the border size
    update_gop_spill(document.getElementsByName("gop_spill")[0]);
}

function tr_text(id) {
    var elem = document.getElementById("iem.prop." + id);
    elem.textContent = l("iem.prop." + id);
}

// Stop-gap translator
function translate_form() {
    var i
    var elements = document.querySelectorAll("[data-i18n]");
    for (i = 0; i < elements.length; i++) {
        var data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_object) {
    var attr;
    for(attr in attr_object) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr)[0];
        if (prop_group !== undefined) {
            console.log("the thing here is " + attr);
            prop_group.classList.remove("hidden");
        }
        // iemguis use the string 'empty' for null because of
        // the limitations of Pd's state-saving API.  So we have
        // to filter that one out
        if (attr_object[attr] !== "empty") {
            var elem = document.getElementsByName(attr);
            if (elem.length > 0) {
                if (attr.slice(-5) === "color") {
                    var hex_string = Number(attr_object[attr]).toString(16);
                    while(hex_string.length < 6) {
                        hex_string = "0" + hex_string;
                    }
                    var color_string = "#" +
                        (hex_string === "0" ? "000000" : hex_string);
                    //pdgui.post("color is " + color_string);
                    elem[0].value = color_string;
                } else if (elem[0].type === "checkbox") {
                    // The attr here is a string, so we need to
                    // force it to number, hence the "+" below
                    elem[0].checked = +attr_object[attr];
                } else if (elem[0].type === "select-one") {
                    elem[0].selectedIndex = +attr_object[attr];
                } else if (attr === "send_symbol" ||
                           attr === "receive_symbol" ||
                           attr === "label") {
                    elem[0].value = iemgui_unescape(attr_object[attr]);
                } else {
                    elem[0].value = attr_object[attr];
                }
            }
        }
    }
}

function add_events(name) {
    // closing the Window
    gui.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        cancel(false);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
